<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Daily Task Update → Zoho Flow</title>
<meta name="robots" content="noindex, nofollow, noarchive">
<meta name="googlebot" content="noindex, nofollow, noarchive">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#fafafa; --card:#ffffff; --ink:#111; --muted:#666; --accent:#0a7e5c; --line:#e8e8ec;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font:16px/1.5 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:960px;margin:20px auto;padding:0 14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:14px;margin-bottom:14px}
  h1{font-size:20px;margin:8px 0 10px;font-weight:600}
  h2{font-size:18px;margin:10px 0;font-weight:600}
  h3{font-size:15px;margin:8px 0 6px;font-weight:600}
  label{display:block;font-size:12.5px;color:var(--muted);margin:6px 0 4px}
  input[type="text"], input[type="date"], select, textarea{
    width:100%;padding:11px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;outline:none
  }
  input,select,textarea{font-family:inherit}
  textarea{min-height:80px;resize:vertical}
  .row{display:grid;gap:12px}
  .grid-3{grid-template-columns:1fr 1fr 1fr}
  .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:999px;font-size:14px}
  .chip input{margin:0}
  .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{
    appearance:none;border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:10px;
    padding:10px 14px;cursor:pointer;font-weight:600
  }
  .btn.secondary{background:#fff;color:var(--accent)}
  .btn.ghost{border-color:var(--line);color:var(--ink);background:#fff}
  .muted{color:var(--muted);font-size:13px}
  .rm-block{border:1px dashed var(--line);border-radius:12px;padding:12px;margin-top:8px}
  .client-block{border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0;background:#fdfdfd}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .right{margin-left:auto}
  .success{border-left:4px solid #16a34a;padding:10px;background:#ecfdf5;border-radius:8px}
  .error{border-left:4px solid #dc2626;padding:10px;background:#fef2f2;border-radius:8px}
  .hidden{display:none}

  /* Tabs */
  .tabs{
    display:flex;gap:8px;align-items:center;overflow:auto;padding:4px 2px 8px 2px;margin:0 0 8px 0;
    scrollbar-width:thin
  }
  .tab{
    flex:0 0 auto; padding:8px 12px; border:1px solid var(--line); background:#fff; border-radius:10px;
    font-weight:600; font-size:14px; cursor:pointer;
  }
  .tab.active{border-color:var(--accent); color:#fff; background:var(--accent)}
  .tab.plus{font-weight:700}

  /* RM header line */
  .rm-header-line{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .rm-title{font-weight:600}
  .rm-count{margin-left:auto;font-size:13px;color:var(--muted)}
  .rm-actions{display:flex;gap:8px;align-items:center;margin-left:auto}

  /* Mobile tweaks */
  @media (max-width:860px){
    .grid-3{grid-template-columns:1fr}
    .bar{gap:8px}
    .btn{width:100%}
    .tabs{gap:6px}
    .tab{padding:8px 10px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Daily Task Update</h1>

      <!-- HEADER: Prepared By (dropdown + custom), Attendance, Date -->
      <div class="row grid-3">
        <div>
          <label for="preparedBySelect">Prepared By</label>
          <select id="preparedBySelect">
            <option value="">Select…</option>
            <option>Satyashree</option>
            <option>Preshita</option>
            <option>Unnati</option>
            <option>Vandana</option>
            <option>Sushant</option>
            <option>Other (type)</option>
          </select>
          <input type="text" id="preparedByCustom" class="hidden" placeholder="Type name" />
        </div>
        <div>
          <label for="attendance">Attendance</label>
          <select id="attendance">
            <option value="">Select…</option>
            <option>Present</option>
            <option>WFH</option>
            <option>Half Day</option>
            <option>Leave</option>
          </select>
        </div>
        <div>
          <label for="reportDate">Date (dd-MM-yyyy)</label>
          <input id="reportDate" type="text" inputmode="numeric" placeholder="dd-MM-yyyy" maxlength="10" />
          <div id="datePreview" class="muted" style="margin-top:4px"></div>
        </div>
      </div>
    </div>

    <!-- TAB BAR -->
    <div class="card">
      <div class="tabs" id="rmTabs">
        <!-- Tabs injected here; includes a [+] tab -->
      </div>
      <div class="bar">
        <span class="muted">Tip: Use the <b>+</b> tab to add new RM groups.</span>
        <span class="right"></span>
        <button id="expandAll" class="btn secondary" type="button">Expand All</button>
        <button id="collapseAll" class="btn secondary" type="button">Collapse All</button>
      </div>
    </div>

    <div id="rmContainer"></div>

    <div class="card">
      <div class="bar">
        <button id="submitBtn" class="btn" type="button">Submit to Zoho Flow</button>
        <button id="copyCliqBtn" class="btn secondary" type="button">Copy Cliq Message</button>
        <span class="muted right">Webhook is configured.</span>
      </div>
      <div id="statusArea" style="margin-top:12px"></div>
    </div>
  </div>

<script>
/** Webhook (your URL) */
const WEBHOOK_URL = "https://flow.zoho.in/60027533273/flow/webhook/incoming?zapikey=1001.d578e23c3472dcfbacc3c4a4eef46a9f.04980ed41a4276af5720dfb2d1fbd4e5&isdebug=false";

const TASKS = ["Portfolio Review","SIP Recommendation","Lumpsum Recommendation","Portfolio Rebalancing","Operations","Coordination","Online Meeting","Offline Meeting","CRM Update","Dashboard Update","Mail MOM","Comprehensive Plan","Quotes Shared"];
const AREAS = ["Health Insurance","Term Insurance","Mutual Funds","Stocks","Bonds","FDs"];

const rmContainer = document.getElementById("rmContainer");
const rmTabs = document.getElementById("rmTabs");
const expandAllBtn = document.getElementById("expandAll");
const collapseAllBtn = document.getElementById("collapseAll");
const submitBtn = document.getElementById("submitBtn");
const copyCliqBtn = document.getElementById("copyCliqBtn");
const statusArea = document.getElementById("statusArea");
const reportDateInput = document.getElementById("reportDate");
const attendanceInput = document.getElementById("attendance");
const preparedBySelect = document.getElementById("preparedBySelect");
const preparedByCustom = document.getElementById("preparedByCustom");

/** Date helpers */
function pad(n){ return n.toString().padStart(2,"0"); }
function monthShort(m){ return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m]; }
function format_ddMMyyyy(date){ return `${pad(date.getDate())}-${pad(date.getMonth()+1)}-${date.getFullYear()}`; }
function parse_ddMMyyyy(str){
  if(!str) return null;
  const m = /^(\d{2})-(\d{2})-(\d{4})$/.exec(str.trim());
  if(!m) return null;
  const dd = parseInt(m[1],10), mm = parseInt(m[2],10), yyyy = parseInt(m[3],10);
  if(mm < 1 || mm > 12 || dd < 1 || dd > 31) return null;
  const d = new Date(yyyy, mm-1, dd);
  return (d.getFullYear()===yyyy && d.getMonth()===(mm-1) && d.getDate()===dd) ? d : null;
}
function maskDateInput(e){
  // keep digits only and auto-insert dashes at 2 and 5
  let v = e.target.value.replace(/[^\d]/g,'').slice(0,8);
  if(v.length >= 5) v = v.slice(0,2) + '-' + v.slice(2,4) + '-' + v.slice(4);
  else if(v.length >= 3) v = v.slice(0,2) + '-' + v.slice(2);
  e.target.value = v;
  updateDatePreview();
}
(function setToday(){
  const today = new Date();
  reportDateInput.value = format_ddMMyyyy(today);
  updateDatePreview();
})();

function updateDatePreview(){
  const el = document.getElementById("datePreview");
  if(!reportDateInput.value){
    el.textContent = "Select a date";
    return;
  }
  const d = parse_ddMMyyyy(reportDateInput.value);
  if(!d){
    el.textContent = "Invalid date (use dd-MM-yyyy)";
    return;
  }
}
reportDateInput.addEventListener("change", updateDatePreview);
reportDateInput.addEventListener("input", maskDateInput);

/** Prepared By dropdown → custom input toggle */
preparedBySelect.addEventListener("change", () => {
  if (preparedBySelect.value === "Other (type)") {
    preparedByCustom.classList.remove("hidden");
    preparedByCustom.focus();
  } else {
    preparedByCustom.classList.add("hidden");
    preparedByCustom.value = "";
  }
});
function getPreparedBy(){
  if(preparedBySelect.value === "Other (type)"){
    return (preparedByCustom.value || "").trim();
  }
  return preparedBySelect.value;
}

/** Chips */
function chips(name, options){
  const wrap = document.createElement("div");
  wrap.className = "chips";
  options.forEach(opt=>{
    const c = document.createElement("label");
    c.className = "chip";
    c.innerHTML = `<input type="checkbox" name="${name}" value="${opt}"><span>${opt}</span>`;
    wrap.appendChild(c);
  });
  return wrap;
}

/** Client block */
function createClientBlock(index){
  const cb = document.createElement("div");
  cb.className="client-block";
  cb.dataset.collapsed="false";
  cb.innerHTML = `
    <div class="bar">
      <h3 style="margin:0">Client ${index}</h3>
      <button class="btn ghost right toggleClient" type="button">Collapse</button>
      <button class="btn secondary removeClient" type="button">Remove</button>
    </div>
    <div class="clientBody">
      <div class="row grid-3">
        <div>
          <label>Client Name</label>
          <input type="text" class="clientName" placeholder="Client full name" />
        </div>
        <div>
          <label>Client Type</label>
          <select class="clientType">
            <option value="">Select…</option>
            <option>New</option>
            <option>Lead</option>
            <option>Existing</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <span class="muted">Tick tasks & areas below</span>
        </div>
      </div>
      <label style="margin-top:10px">Tasks (tick relevant)</label>
      <div class="tasksWrap"></div>
      <label>Area (tick relevant)</label>
      <div class="areasWrap"></div>
      <label>Notes</label>
      <textarea class="notes" placeholder="Key updates, action taken, next steps"></textarea>
    </div>
  `;
  cb.querySelector(".tasksWrap").appendChild(chips("tasks", TASKS));
  cb.querySelector(".areasWrap").appendChild(chips("areas", AREAS));
  return cb;
}

/** RM block (RM Name + Total Clients on header line) */
let rmSeq = 0;
function createRmBlock(){
  rmSeq += 1;
  const id = `rm_${rmSeq}`;
  const rb = document.createElement("div");
  rb.className="card rm-block";
  rb.dataset.rmid = id;
  rb.innerHTML = `
    <div class="bar">
      <div class="rm-header-line" style="width:100%">
        <span class="rm-title">RM Name:</span>
        <input type="text" class="rmName" placeholder="Type RM name" style="max-width:260px" />
        <span class="rm-count">Total Clients: <strong class="clientCount">0</strong></span>
        <div class="rm-actions right">
          <button class="btn secondary addClient" type="button">+ Add Client</button>
          <button class="btn ghost removeRm" type="button">Remove RM</button>
        </div>
      </div>
    </div>
    <div class="clients"></div>
  `;
  const clientsWrap = rb.querySelector(".clients");
  clientsWrap.appendChild(createClientBlock(1));
  updateAllCounts();
  return rb;
}

/** Tabs */
function renderTabs(){
  rmTabs.innerHTML = "";
  const blocks = Array.from(document.querySelectorAll(".rm-block"));
  blocks.forEach((rb, idx)=>{
    const name = rb.querySelector(".rmName").value.trim();
    const count = rb.querySelectorAll(".client-block").length;
    const label = name ? name : `RM ${idx+1}`;
    const tab = document.createElement("button");
    tab.className = "tab";
    tab.textContent = `${label}${count ? ` (${count})` : ""}`;
    tab.dataset.rmid = rb.dataset.rmid;
    if (idx === activeRmIndex()) tab.classList.add("active");
    rmTabs.appendChild(tab);
  });
  const plus = document.createElement("button");
  plus.className = "tab plus";
  plus.textContent = "+";
  plus.title = "Add RM";
  plus.dataset.plus = "1";
  rmTabs.appendChild(plus);
}

function activeRmIndex(){
  const blocks = Array.from(document.querySelectorAll(".rm-block"));
  const firstVisible = blocks.findIndex(b => b.style.display !== "none");
  return firstVisible === -1 ? 0 : firstVisible;
}

function showOnlyRmById(rmId){
  document.querySelectorAll(".rm-block").forEach(b=>{
    b.style.display = (b.dataset.rmid === rmId) ? "" : "none";
  });
  renderTabs();
}

/** Insert initial RM */
const firstRM = createRmBlock();
rmContainer.appendChild(firstRM);
showOnlyRmById(firstRM.dataset.rmid);

/** Add RM (tab + block) */
function addRm(){
  const rb = createRmBlock();
  rmContainer.appendChild(rb);
  showOnlyRmById(rb.dataset.rmid);
}

/** Tab interactions */
rmTabs.addEventListener("click",(e)=>{
  const plus = e.target.closest(".tab.plus");
  const tab = e.target.closest(".tab:not(.plus)");
  if(plus){ addRm(); return; }
  if(tab){ showOnlyRmById(tab.dataset.rmid); }
});

/** Update tab labels live when RM name changes */
rmContainer.addEventListener("input",(e)=>{
  if(e.target.classList.contains("rmName")){
    renderTabs();
  }
});

/** Expand/Collapse all clients (in current RM) */
expandAllBtn.addEventListener("click",()=>{
  const current = document.querySelector('.rm-block:not([style*="display: none"])');
  if(!current) return;
  current.querySelectorAll(".client-block").forEach(cb=>{
    cb.dataset.collapsed="false";
    cb.querySelector(".clientBody").style.display="";
    cb.querySelector(".toggleClient").textContent="Collapse";
  });
});
collapseAllBtn.addEventListener("click",()=>{
  const current = document.querySelector('.rm-block:not([style*="display: none"])');
  if(!current) return;
  current.querySelectorAll(".client-block").forEach(cb=>{
    cb.dataset.collapsed="true";
    cb.querySelector(".clientBody").style.display="none";
    cb.querySelector(".toggleClient").textContent="Expand";
  });
});

/** Event delegation for dynamic buttons inside rmContainer */
rmContainer.addEventListener("click",(e)=>{
  const addBtn = e.target.closest(".addClient");
  const removeClientBtn = e.target.closest(".removeClient");
  const toggleBtn = e.target.closest(".toggleClient");
  const removeRmBtn = e.target.closest(".removeRm");

  if(addBtn){
    const rmBlock = addBtn.closest(".rm-block");
    const wrap = rmBlock.querySelector(".clients");
    const count = wrap.querySelectorAll(".client-block").length;
    if(count>=10){ alert("Limit: 10 clients per RM."); return; }
    wrap.appendChild(createClientBlock(count+1));
    updateAllCounts();
  }
  if(removeClientBtn){
    const cb = removeClientBtn.closest(".client-block");
    const rmBlock = removeClientBtn.closest(".rm-block");
    cb.remove();
    resequenceClients(rmBlock);
    updateAllCounts();
  }
  if(toggleBtn){
    const cb = toggleBtn.closest(".client-block");
    const body = cb.querySelector(".clientBody");
    const collapsed = cb.dataset.collapsed==="true";
    cb.dataset.collapsed = collapsed ? "false" : "true";
    body.style.display = collapsed ? "" : "none";
    toggleBtn.textContent = collapsed ? "Collapse" : "Expand";
  }
  if(removeRmBtn){
    const rm = removeRmBtn.closest(".rm-block");
    const siblings = Array.from(document.querySelectorAll(".rm-block"));
    const idx = siblings.indexOf(rm);
    rm.remove();
    // Show another RM if exists
    const next = document.querySelector(".rm-block");
    if(next){ next.style.display = ""; }
    updateAllCounts();
  }
});

/** Helpers */
function resequenceClients(rmBlock){
  rmBlock.querySelectorAll(".client-block h3").forEach((h3, idx)=> h3.textContent = `Client ${idx+1}`);
}
function updateAllCounts(){
  document.querySelectorAll(".rm-block").forEach(rb=>{
    const count = rb.querySelectorAll(".client-block").length;
    const cc = rb.querySelector(".clientCount");
    if(cc) cc.textContent = count;
    resequenceClients(rb);
  });
  renderTabs();
}

/** Collect data */
function collectData(){
  // Date input is dd-MM-yyyy → keep as dd-MM-yyyy (validated via parse)
  let outDate = "";
  if(reportDateInput.value){
    const d = parse_ddMMyyyy(reportDateInput.value);
    if(d) outDate = format_ddMMyyyy(d);
  }
  const attendance = attendanceInput.value;
  const preparedBy = getPreparedBy();

  const rms = [];
  document.querySelectorAll(".rm-block").forEach(rb=>{
    const rmName = rb.querySelector(".rmName").value.trim();
    const clients = [];
    rb.querySelectorAll(".client-block").forEach((cb, idx)=>{
      const clientName = cb.querySelector(".clientName").value.trim();
      const type = cb.querySelector(".clientType").value;
      const notes = cb.querySelector(".notes").value.trim();
      const tasks = Array.from(cb.querySelectorAll('input[name="tasks"]:checked')).map(x=>x.value);
      const areas = Array.from(cb.querySelectorAll('input[name="areas"]:checked')).map(x=>x.value);
      if(!clientName && !type && tasks.length===0 && areas.length===0 && !notes){ return; }
      clients.push({ index: idx+1, name: clientName, type, tasks, areas, notes });
    });
    if(!rmName && clients.length===0){ return; }
    rms.push({ rmName, clients, total_clients: rb.querySelectorAll(".client-block").length });
  });

  return { date: outDate, preparedBy, attendance, rms };
}

/** Cliq message */
function buildCliqMessage(payload){
  const lines = [];
  lines.push(`*Daily Task Update – ${payload.date || format_ddMMyyyy(new Date())}*`);
  lines.push(`Prepared by: ${payload.preparedBy || "N/A"}`);
  lines.push(`Attendance: ${payload.attendance || "N/A"}`);
  lines.push("");

  payload.rms.forEach((rm)=>{
    lines.push(`*RM:* ${rm.rmName || "N/A"}  ·  *Total Clients:* ${rm.total_clients ?? 0}`);
    if(!rm.clients || rm.clients.length===0){ lines.push("_No client entries_"); lines.push(""); return; }
    rm.clients.forEach((c)=>{
      lines.push(`${c.index}) *Client:* ${c.name || "N/A"}  ·  *Type:* ${c.type || "N/A"}`);
      if(c.tasks?.length) lines.push(`   • *Tasks:* ${c.tasks.join(", ")}`);
      if(c.areas?.length) lines.push(`   • *Area:* ${c.areas.join(", ")}`);
      if(c.notes) lines.push(`   • *Notes:* ${c.notes}`);
    });
    lines.push("");
  });

  return lines.join("\n");
}

/** Validation */
function validate(payload){
  if(!payload.date) return "Please select Date.";
  const pb = payload.preparedBy || "";
  if(pb.trim().length===0) return "Please select or type Prepared By.";
  if(!payload.attendance) return "Please select Attendance.";
  if(payload.rms.length===0) return "Add at least one RM and one client row with some data.";
  for(const rm of payload.rms){
    if(rm.clients.length>0 && !rm.rmName) return "RM Name is required for each RM group.";
    for(const c of rm.clients){
      if(!c.name) return "Client Name is required for each client row.";
      if(!c.type) return "Client Type is required for each client row.";
    }
  }
  return null;
}

function showStatus(html, isError=false){
  statusArea.innerHTML = `<div class="${isError?'error':'success'}">${html}</div>`;
}

/** Build flat rows for Google Sheets (11 fields per client) */
function buildRows(payload){
  const rows = [];
  const date = payload.date || "";
  const preparedBy = payload.preparedBy || "";
  const attendance = payload.attendance || "";
  (payload.rms || []).forEach(item=>{
    const rmName = item.rmName || "";
    const rmTotalClients = item.total_clients ?? ((item.clients||[]).length);
    (item.clients || []).forEach(child=>{
      rows.push({
        date,
        preparedBy,
        attendance,
        rmName,
        clientIndex: child.index ?? "",
        clientName: child.name || "",
        clientType: child.type || "",
        tasks: (child.tasks || []).join(", "),
        areas: (child.areas || []).join(", "),
        notes: child.notes || "",
        rmTotalClients
      });
    });
  });
  return rows;
}

/** Copy Cliq message */
copyCliqBtn.addEventListener("click",()=>{
  const payload = collectData();
  const err = validate(payload);
  if(err){ showStatus(err, true); return; }
  const cliq = buildCliqMessage(payload);
  navigator.clipboard.writeText(cliq).then(()=> showStatus("Cliq message copied."))
    .catch(()=> showStatus("Could not copy to clipboard.", true));
});

/** Submit to Zoho Flow */
submitBtn.addEventListener("click", async ()=>{
  const payload = collectData();
  const err = validate(payload);
  // Build flat 11-column rows and embed in the payload for convenience
  const rows = buildRows(payload);
  payload.rows = rows;
  if(err){ showStatus(err, true); return; }

  // offline guard
  if (typeof navigator !== "undefined" && navigator && navigator.onLine === false) {
    showStatus("You're offline. Connect to the internet and try again.", true);
    return;
  }

  const cliq_message = buildCliqMessage(payload);

  try{
    // Build a simple x-www-form-urlencoded body.
    // Many webhook services (including Zoho Flow) parse these fields reliably.
    const params = new URLSearchParams();
    params.append("date", payload.date || "");
    params.append("preparedBy", payload.preparedBy || "");
    params.append("attendance", payload.attendance || "");
    params.append("payload", JSON.stringify(payload));             // full payload with rows
    params.append("payload_json", JSON.stringify(payload));        // duplicate for Flow convenience
    params.append("rms_json", JSON.stringify(payload.rms || []));  // nested rms only
    params.append("rows_json", JSON.stringify(rows || []));        // NEW: flat 11-field rows
    // Cliq
    params.append("cliq_message", cliq_message || "");

    const bytes = new Blob([params.toString()]).size;

    showStatus("Submitting…");
    await fetch(WEBHOOK_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: params.toString()
    });

    showStatus(`Sent to Zoho Flow. (Local check: form body ${bytes} bytes). In Flow history you should now see: date/preparedBy/attendance, payload (with rows), rms_json, and rows_json.`);
  }catch(e){
    showStatus("Could not send from the browser. If this persists, contact Pranob.", true);
  }
});
</script>
</body>
</html>