<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Submission Tracker (9-Hour Breakdown)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --accent: #009356;
      --accent-2: #3bcf84;
      --text: #0e1a2b;
      --muted: #5b6b82;
      --line: #e2e8f0;
      --warn: #c98a1b;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(900px 520px at 10% 0%, #eef3ff, #f5f7fb 60%);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
    }

    .wrap {
      width: min(1100px, 100%);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 22px;
      box-shadow: 0 25px 60px rgba(20, 30, 60, 0.12);
    }

    header {
      display: grid;
      gap: 10px;
      margin-bottom: 18px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(22px, 3vw, 34px);
      letter-spacing: 0.2px;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }

    .pill-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-bottom: 0;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    .inline-controls {
      display: flex;
      align-items: flex-end;
      gap: 16px;
      flex-wrap: wrap;
    }

    .inline-field {
      min-width: 220px;
    }

    .button-row {
      display: inline-flex;
      gap: 12px;
      align-items: flex-end;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .btn-col {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .btn-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      line-height: 1.2;
    }

    .button-row .icon-btn {
      width: 40px;
      height: 40px;
      padding: 0;
      border-radius: 10px;
    }

    .button-row .secondary {
      min-height: 40px;
    }

    .inline-field input {
      min-height: 40px;
    }

    label {
      display: grid;
      gap: 6px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      line-height: 1.2;
    }

    .pill-row label {
      margin-bottom: 0;
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      border: 1px solid var(--line);
      background: #ffffff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      font-family: inherit;
      font-size: 14px;
    }

    input[type="number"] {
      text-align: center;
      min-width: 70px;
      padding: 10px 12px;
      appearance: textfield;
      -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      border: 1px solid transparent;
      background: linear-gradient(180deg, #009356 0%, #007a49 100%);
      color: #ffffff;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      line-height: 1.2;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button.secondary {
      background: transparent;
      color: var(--text);
      border-color: var(--line);
    }

    .table-wrap {
      margin-top: 18px;
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: #ffffff;
    }

    thead {
      background: #f3f6fb;
    }

    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      vertical-align: middle;
    }

    th {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    td.task {
      width: 100%;
      min-width: 240px;
    }

    textarea {
      min-height: 48px;
      resize: vertical;
    }

    .time-cell {
      display: grid;
      gap: 6px;
      min-width: 120px;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    .note {
      margin-top: 12px;
      font-size: 12px;
      color: var(--warn);
    }

    .status {
      margin-left: auto;
      font-size: 12px;
      color: var(--muted);
    }

    .status.error {
      color: #b42318;
    }

    .status.success {
      color: #067647;
    }

    .hidden-row {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transform: translateY(-6px);
      transition: max-height 300ms ease, opacity 300ms ease, transform 300ms ease;
    }

    tr {
      transition: max-height 300ms ease, opacity 300ms ease, transform 300ms ease;
    }

    tr:not(.hidden-row) {
      max-height: 900px;
      opacity: 1;
      transform: translateY(0);
    }

    .delete-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: 1px solid var(--line);
      background: #ffffff;
      border-radius: 8px;
      cursor: pointer;
    }

    .delete-btn i {
      color: #d92d20;
      font-size: 14px;
    }

    .icon-btn {
      border: 1px solid var(--line);
      background: #ffffff;
      color: var(--text);
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .icon-btn i {
      font-size: 13px;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      width: min(420px, 100%);
      background: #ffffff;
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
      padding: 16px 18px;
      display: grid;
      gap: 12px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 16px;
    }

    .modal-body {
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-line;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .submit-bar {
      margin-top: 16px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .controls .icon-btn {
      width: 40px;
      height: 40px;
    }

    .actions .secondary {
      background: #eef2f7;
      border: 1px solid #d6dee8;
      color: var(--text);
      box-shadow: none;
    }

    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pill {
      border: 1px solid var(--line);
      background: #ffffff;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.18s ease;
      user-select: none;
    }

    .pill.active {
      border-color: #007a49;
      background: #e9f8f0;
      color: #005a35;
      box-shadow: 0 6px 14px rgba(0, 122, 73, 0.15);
    }

    @media (max-width: 720px) {
      body {
        padding: 12px;
      }

      .wrap {
        padding: 16px;
      }

      .controls {
        grid-template-columns: 1fr;
      }

      .actions {
        flex-direction: column;
        align-items: stretch;
      }

      .actions button {
        width: 100%;
      }

      .muted, .status {
        width: 100%;
        text-align: left;
      }

      .inline-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .button-row {
        flex-direction: column;
      }

      table, thead, tbody, tr, td, th {
        display: block;
        width: 100%;
      }

      thead {
        display: none;
      }

      tr {
        display: flex;
        flex-wrap: wrap;
        padding: 12px 10px;
        border-bottom: 1px solid var(--line);
        border-radius: 12px;
        background: #ffffff;
        margin-bottom: 10px;
        position: relative;
      }

      td {
        border: none;
        padding: 8px 0;
      }

      td.start-cell,
      td.end-cell,
      td.hours-cell,
      td.mins-cell {
        flex: 0 0 49%;
      }

      td.start-cell,
      td.hours-cell {
        margin-right: 2%;
      }

      td.task-cell,
      td.remove-cell,
      td.task-label-cell {
        flex: 0 0 100%;
      }

      td.task-label-cell { order: 0; }
      td.start-cell { order: 1; }
      td.end-cell { order: 2; }
      td.hours-cell { order: 3; }
      td.mins-cell { order: 4; }
      td.task-cell { order: 5; }
      td.remove-cell { order: 6; }

      td.remove-cell {
        position: absolute;
        top: 12px;
        right: 10px;
        width: auto;
        margin: 0;
      }

      td::before {
        content: attr(data-label);
        display: block;
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 4px;
      }

      .time-cell {
        min-width: 100px;
      }

      textarea {
        min-height: 80px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Task Submission Tracker</h1>
      <p>Plan and log a 9-hour day. Set a start time, add minutes and hours per block, and write tasks.</p>
      <div class="controls">
        <div class="pill-row">
          <div id="deptSection">
            <label>Department</label>
            <div id="deptPills" class="pill-group" role="radiogroup" aria-label="Department"></div>
          </div>
          <div id="nameSection">
            <label>Name</label>
            <div id="namePills" class="pill-group" role="radiogroup" aria-label="Name"></div>
          </div>
        </div>
        <div class="grid-2">
          <label>
            Date
            <input id="workDate" type="date" />
          </label>
          <label>
            Start Time
            <input id="startTime" type="time" value="09:00" />
          </label>
          <label>
            End Time (Auto)
            <input id="endTime" type="time" />
          </label>
          <label>
            Day Type
            <select id="dayType">
              <option value="full" selected>Full Day</option>
              <option value="half">Half Day</option>
            </select>
          </label>
        </div>
        <div class="inline-controls">
          <label class="inline-field">
            Default Task minutes
            <input id="defaultMinutes" type="number" min="15" step="15" value="60" />
          </label>
          <div class="button-row">
            <div class="btn-col">
              <span class="btn-label">Undo</span>
              <button id="undoDelete" class="icon-btn" title="Undo delete" aria-label="Undo delete">
                <i class="fa-solid fa-rotate-left"></i>
              </button>
            </div>
            <div class="btn-col">
              <span class="btn-label">Reset</span>
              <button id="reset" class="secondary">Reset</button>
            </div>
            <div class="btn-col">
              <span class="btn-label">Add</span>
              <button id="addRow" class="secondary">Add</button>
            </div>
          </div>
        </div>
      </div>
      <div class="actions">
        <span class="muted">Total duration updates automatically based on each block.</span>
        <span class="status" id="status"></span>
      </div>
    </header>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Block</th>
            <th>Start</th>
            <th>Add Hours</th>
            <th>Add Minutes</th>
            <th>End</th>
            <th>Tasks / Deliverables</th>
            <th>Remove</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="note" id="summary">Total scheduled: 0h 0m</div>
    <div class="note">If any task block is missing, start typing in the last task box.</div>
    <div class="submit-bar">
      <button id="viewSummary" class="secondary">
        <i class="fa-regular fa-eye"></i>
        View Message
      </button>
      <button id="submit">
        <i class="fa-solid fa-paper-plane"></i>
        Submit to Zoho Flow
      </button>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h2 id="modalTitle">Notice</h2>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-actions">
        <button id="modalCancel" class="secondary">Cancel</button>
        <button id="modalConfirm">OK</button>
      </div>
    </div>
  </div>

  <script>
    const rowsEl = document.getElementById("rows");
    const startTimeEl = document.getElementById("startTime");
    const defaultMinutesEl = document.getElementById("defaultMinutes");
    const summaryEl = document.getElementById("summary");
    const resetBtn = document.getElementById("reset");
    const addRowBtn = document.getElementById("addRow");
    const undoDeleteBtn = document.getElementById("undoDelete");
    const submitBtn = document.getElementById("submit");
    const statusEl = document.getElementById("status");
    const endTimeEl = document.getElementById("endTime");
    const dayTypeEl = document.getElementById("dayType");
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalCancel = document.getElementById("modalCancel");
    const modalConfirm = document.getElementById("modalConfirm");
    const viewSummaryBtn = document.getElementById("viewSummary");
    const deptPillsEl = document.getElementById("deptPills");
    const deptSectionEl = document.getElementById("deptSection");
    const nameSectionEl = document.getElementById("nameSection");
    const namePillsEl = document.getElementById("namePills");

    const WEBHOOK_URL = "https://flow.zoho.in/60027533273/flow/webhook/incoming?zapikey=1001.262d73321ec4cf092dc34d6310e3dee8.f22019fbcce0c6084f92ac9de2262976&isdebug=false";
    let currentBlockIndex = 0;
    let endTimeManual = false;
    let suppressEndTimeConfirm = false;
    let isAdjustingBlocks = false;
    let modalActive = false;
    let lastDeletedBlock = null;
    const departmentMap = {
      "Information Technology": [
        "Shalin Bhavsar",
        "Pranav Shah",
        "Anoj Tambe",
        "Gunjan Rusia",
        "Thakur Prasad"
      ],
      "Operations": [
        "Pravin Mayekar",
        "Rahul Meher",
        "Nagma Sheikh",
        "Amit Lad",
        "Akshay Jadhav"
      ],
      "Research": [
        "Riya Jain",
        "Rushabh Dugad",
        "Humaid Khot",
        "Yash Asrani",
        "Vinjal Rao",
        "Ria Ignatious"
      ],
      "Equity": [
        "Gaurav Haldankar",
        "Milind Jain",
        "Jinal Shah"
      ],
      "Direct Reportees": [
        "Pranob Thachanthara",
        "Rajvi Gori",
        "Chintan Dudhela",
        "Sagar Maheshwari",
        "Jignesh Gajjar",
        "Jayant Furia",
        "Vandana Manwani"
      ]
    };
    const departments = Object.keys(departmentMap);
    let selectedDept = "";
    let selectedName = "";

    function parseTimeToMinutes(timeStr) {
      if (!timeStr) return null;
      const [hh, mm] = timeStr.split(":").map(Number);
      if (Number.isNaN(hh) || Number.isNaN(mm)) return null;
      return hh * 60 + mm;
    }

    function minutesToTime(mins) {
      const safe = ((mins % 1440) + 1440) % 1440;
      const h = Math.floor(safe / 60).toString().padStart(2, "0");
      const m = Math.floor(safe % 60).toString().padStart(2, "0");
      return `${h}:${m}`;
    }

    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function formatDateLong(iso) {
      if (!iso || !iso.includes("-")) return iso || "-";
      const [y, m, d] = iso.split("-");
      const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      const month = monthNames[parseInt(m, 10) - 1] || m;
      return `${d} ${month} ${y}`;
    }

    function getRequiredMinutes() {
      if (dayTypeEl.value === "half") return 300;
      return 540;
    }

    function setAutoEndTime() {
      const startMins = parseTimeToMinutes(startTimeEl.value) ?? 540;
      const requiredMinutes = getRequiredMinutes();
      endTimeEl.value = minutesToTime(startMins + requiredMinutes);
    }

    function addBlockRow(startMins) {
      const defaultMinutes = parseInt(defaultMinutesEl.value, 10) || 60;
      const row = buildRow(rowsEl.querySelectorAll("tr").length, startMins, defaultMinutes);
      rowsEl.appendChild(row);
      wireRow(row, rowsEl.querySelectorAll("tr").length - 1);
    }

    function restoreDeletedBlock() {
      if (!lastDeletedBlock) return false;
      const rows = Array.from(rowsEl.querySelectorAll("tr"));
      const insertIndex = Math.min(lastDeletedBlock.index, rows.length);
      const startMins = insertIndex === 0
        ? (parseTimeToMinutes(startTimeEl.value) ?? 540)
        : (parseTimeToMinutes(rows[insertIndex - 1].querySelector(".end").value) ?? 540);
      const defaultMinutes = parseInt(defaultMinutesEl.value, 10) || 60;
      const row = buildRow(insertIndex, startMins, defaultMinutes);
      if (rows[insertIndex]) {
        rowsEl.insertBefore(row, rows[insertIndex]);
      } else {
        rowsEl.appendChild(row);
      }
      row.querySelector(".add-hours").value = lastDeletedBlock.addHours;
      row.querySelector(".add-mins").value = lastDeletedBlock.addMins;
      row.querySelector("textarea").value = lastDeletedBlock.task;
      wireRow(row, insertIndex);
      lastDeletedBlock = null;
      recalcFrom(insertIndex);
      applyBlockVisibility();
      persistState();
      return true;
    }

    function ensureBlocksForEndTime() {
      const startMins = parseTimeToMinutes(startTimeEl.value) ?? 540;
      const endMins = parseTimeToMinutes(endTimeEl.value);
      if (endMins === null) return;
      const defaultMinutes = parseInt(defaultMinutesEl.value, 10) || 60;
      if (defaultMinutes <= 0) return;

      const duration = ((endMins - startMins) + 1440) % 1440;
      const effectiveDuration = duration === 0 ? getRequiredMinutes() : duration;
      const neededBlocks = Math.max(1, Math.ceil(effectiveDuration / defaultMinutes));
      const currentBlocks = rowsEl.querySelectorAll("tr").length;

      if (neededBlocks > currentBlocks) {
        let lastEnd = currentBlocks
          ? parseTimeToMinutes(rowsEl.querySelectorAll("tr")[currentBlocks - 1].querySelector(".end").value) ?? startMins
          : startMins;
        for (let i = currentBlocks; i < neededBlocks; i++) {
          addBlockRow(lastEnd);
          lastEnd += defaultMinutes;
        }
      }
      if (neededBlocks < currentBlocks) {
        const rows = Array.from(rowsEl.querySelectorAll("tr"));
        for (let i = rows.length - 1; i >= neededBlocks; i--) {
          rows[i].remove();
        }
        if (currentBlockIndex >= neededBlocks) {
          currentBlockIndex = Math.max(0, neededBlocks - 1);
        }
      }
      recalcFrom(0);
      applyBlockVisibility();
      persistState();
    }

    function buildRow(index, startMins, defaultMinutes) {
      const tr = document.createElement("tr");
      tr.dataset.index = index;
      const addHours = Math.floor(defaultMinutes / 60);
      const addMins = defaultMinutes % 60;

      tr.innerHTML = `
        <td data-label="Task" class="task-label-cell">Task ${index + 1}</td>
        <td data-label="Start" class="start-cell">
          <div class="time-cell">
            <input type="time" class="start" value="${minutesToTime(startMins)}" />
          </div>
        </td>
        <td data-label="Add Hours" class="hours-cell">
          <input type="number" class="add-hours" min="0" max="8" value="${addHours}" />
        </td>
        <td data-label="Add Minutes" class="mins-cell">
          <input type="number" class="add-mins" min="0" max="59" step="15" value="${addMins}" />
        </td>
        <td data-label="End" class="end-cell">
          <div class="time-cell">
            <input type="time" class="end" value="${minutesToTime(startMins + defaultMinutes)}" />
          </div>
        </td>
        <td class="task task-cell" data-label="Tasks / Deliverables">
          <textarea placeholder="What did you do in this block?"></textarea>
        </td>
        <td data-label="Remove" class="remove-cell">
          <button class="delete-btn delete-row" type="button" title="Delete block" aria-label="Delete block">
            <i class="fa-solid fa-trash"></i>
          </button>
        </td>
      `;

      return tr;
    }

    function serializeState() {
      return {
        currentBlockIndex,
        endTimeManual,
        department: selectedDept,
        employeeName: selectedName,
        workDate: document.getElementById("workDate").value,
        dayType: dayTypeEl.value,
        startTime: startTimeEl.value,
        defaultMinutes: defaultMinutesEl.value,
        endTime: endTimeEl.value,
        blocks: Array.from(rowsEl.querySelectorAll("tr")).map((row) => ({
          start: row.querySelector(".start").value,
          addHours: row.querySelector(".add-hours").value,
          addMinutes: row.querySelector(".add-mins").value,
          end: row.querySelector(".end").value,
          task: row.querySelector("textarea").value,
        })),
      };
    }

    function persistState() {
      localStorage.setItem("taskTrackerState", JSON.stringify(serializeState()));
    }

    function restoreState() {
      const raw = localStorage.getItem("taskTrackerState");
      if (!raw) return false;
      try {
        const state = JSON.parse(raw);
        currentBlockIndex = typeof state.currentBlockIndex === "number" ? state.currentBlockIndex : 0;
        endTimeManual = Boolean(state.endTimeManual);
        selectedDept = state.department || "";
        selectedName = state.employeeName || "";
        document.getElementById("workDate").value = state.workDate || todayISO();
        dayTypeEl.value = state.dayType || "full";
        startTimeEl.value = state.startTime || "09:00";
        defaultMinutesEl.value = state.defaultMinutes || 60;

        rowsEl.innerHTML = "";
        const blocks = Array.isArray(state.blocks) ? state.blocks : [];
        if (blocks.length) {
          blocks.forEach((block, i) => {
            const startMins = parseTimeToMinutes(block.start) ?? 0;
            const row = buildRow(i, startMins, parseInt(defaultMinutesEl.value, 10) || 60);
            rowsEl.appendChild(row);
            row.querySelector(".start").value = block.start || row.querySelector(".start").value;
            row.querySelector(".add-hours").value = block.addHours ?? 0;
            row.querySelector(".add-mins").value = block.addMinutes ?? 0;
            row.querySelector(".end").value = block.end || row.querySelector(".end").value;
            row.querySelector("textarea").value = block.task || "";
            wireRow(row, i);
          });
          recalcFrom(0);
        } else {
          generateRows();
        }
        if (!state.endTime) {
          setAutoEndTime();
        } else {
          endTimeEl.value = state.endTime;
        }
        applyBlockVisibility();
        updateRemoveButtons();
        return true;
      } catch (e) {
        return false;
      }
    }

    function totalScheduledMinutes() {
      let total = 0;
      rowsEl.querySelectorAll("tr").forEach((row) => {
        const start = parseTimeToMinutes(row.querySelector(".start").value);
        const end = parseTimeToMinutes(row.querySelector(".end").value);
        if (start !== null && end !== null) {
          const duration = ((end - start) + 1440) % 1440;
          total += duration;
        }
      });
      return total;
    }

    function updateSummary() {
      const total = totalScheduledMinutes();
      const h = Math.floor(total / 60);
      const m = total % 60;
      const requiredMinutes = getRequiredMinutes();
      const targetLabel = dayTypeEl.value === "half"
        ? "Minimum 5h (Half Day)"
        : "Minimum 9h";
      summaryEl.textContent = `Total scheduled: ${h}h ${m}m`;
      if (dayTypeEl.value === "half") {
        if (total < requiredMinutes) {
          summaryEl.textContent += ` (Target: ${targetLabel})`;
        }
      } else if (total < requiredMinutes) {
        summaryEl.textContent += ` (Target: ${targetLabel})`;
      }
    }

    function recalcFrom(rowIndex) {
      const rows = Array.from(rowsEl.querySelectorAll("tr"));
      const mainEndMins = parseTimeToMinutes(endTimeEl.value);
      const defaultMinutes = parseInt(defaultMinutesEl.value, 10) || 60;
      const defaultHours = Math.floor(defaultMinutes / 60);
      const defaultMins = defaultMinutes % 60;
      for (let i = rowIndex; i < rows.length; i++) {
        const row = rows[i];
        const startInput = row.querySelector(".start");
        const endInput = row.querySelector(".end");
        if (i > rowIndex) {
          row.querySelector(".add-hours").value = defaultHours;
          row.querySelector(".add-mins").value = defaultMins;
        }
        const addHours = parseInt(row.querySelector(".add-hours").value, 10) || 0;
        const addMins = parseInt(row.querySelector(".add-mins").value, 10) || 0;
        const startMins = parseTimeToMinutes(startInput.value) ?? 0;
        let endMins = startMins + addHours * 60 + addMins;
        if (mainEndMins !== null && endMins > mainEndMins) {
          endMins = mainEndMins;
        }
        endInput.value = minutesToTime(endMins);
        const actualDuration = ((endMins - startMins) + 1440) % 1440;
        row.querySelector(".add-hours").value = Math.floor(actualDuration / 60);
        row.querySelector(".add-mins").value = actualDuration % 60;

        if (i + 1 < rows.length) {
          const nextStart = rows[i + 1].querySelector(".start");
          nextStart.value = minutesToTime(endMins);
        }
      }
      rows.forEach((row, i) => {
        row.querySelector("td").textContent = `Task ${i + 1}`;
        row.dataset.index = i;
      });
      trimZeroDurationTail();
      if (mainEndMins !== null) {
        const lastEnd = rows.length
          ? parseTimeToMinutes(rows[rows.length - 1].querySelector(".end").value) ?? mainEndMins
          : null;
        if (lastEnd !== null && lastEnd < mainEndMins) {
          const defaultMinutes = parseInt(defaultMinutesEl.value, 10) || 60;
          let nextStart = lastEnd;
          while (nextStart < mainEndMins) {
            addBlockRow(nextStart);
            nextStart += defaultMinutes;
          }
          recalcFrom(0);
          return;
        }
      }
      const total = totalScheduledMinutes();
      const requiredMinutes = getRequiredMinutes();
      if (total > requiredMinutes) {
        currentBlockIndex = rows.length - 1;
        applyBlockVisibility();
      }
      if (endTimeManual && !isAdjustingBlocks) {
        isAdjustingBlocks = true;
        ensureBlocksForEndTime();
        isAdjustingBlocks = false;
      }
      updateSummary();
      updateRemoveButtons();
      persistState();
    }

    function trimZeroDurationTail() {
      const rows = Array.from(rowsEl.querySelectorAll("tr"));
      if (rows.length <= 1) return;
      for (let i = rows.length - 1; i >= 0; i--) {
        const row = rows[i];
        const start = parseTimeToMinutes(row.querySelector(".start").value);
        const end = parseTimeToMinutes(row.querySelector(".end").value);
        if (start !== null && end !== null && start === end) {
          row.remove();
        } else {
          break;
        }
      }
    }

    function applyBlockVisibility() {
      const rows = Array.from(rowsEl.querySelectorAll("tr"));
      if (!rows.length) return;

      rows.forEach((row, i) => {
        row.classList.toggle("hidden-row", i > currentBlockIndex);
      });
    }

    function updateRemoveButtons() {
      const rows = Array.from(rowsEl.querySelectorAll("tr"));
      rows.forEach((row, i) => {
        const btn = row.querySelector(".delete-row");
        if (!btn) return;
        const isLast = i === rows.length - 1;
        btn.disabled = !isLast;
        btn.style.opacity = isLast ? "1" : "0.4";
        btn.style.cursor = isLast ? "pointer" : "not-allowed";
      });
    }

    function wireRow(row, index) {
      const maybeRevealNext = () => {
        const rows = Array.from(rowsEl.querySelectorAll("tr"));
        if (index === currentBlockIndex && index + 1 < rows.length) {
          currentBlockIndex = index + 1;
          applyBlockVisibility();
          persistState();
        }
      };

      row.querySelectorAll(".add-hours, .add-mins").forEach((input) => {
        input.addEventListener("focus", () => {
          row.dataset.prevHours = row.querySelector(".add-hours").value;
          row.dataset.prevMins = row.querySelector(".add-mins").value;
        });
        input.addEventListener("input", async () => {
          const rows = Array.from(rowsEl.querySelectorAll("tr"));
          const lastIndex = rows.length - 1;
          const startMins = parseTimeToMinutes(row.querySelector(".start").value) ?? 0;
          const addHours = parseInt(row.querySelector(".add-hours").value, 10) || 0;
          const addMins = parseInt(row.querySelector(".add-mins").value, 10) || 0;
          const proposedEnd = startMins + addHours * 60 + addMins;
          const mainEndMins = parseTimeToMinutes(endTimeEl.value);
          if (mainEndMins !== null && proposedEnd > mainEndMins && !suppressEndTimeConfirm) {
            const ok = await openModal({
              title: "Extend End Time?",
              message: "This block exceeds the main End Time. Update End Time to fit?",
              confirmText: "Update",
              cancelText: "Keep",
              showCancel: true
            });
            if (!ok) {
              suppressEndTimeConfirm = true;
              const prevHours = row.dataset.prevHours ?? row.querySelector(".add-hours").value;
              const prevMins = row.dataset.prevMins ?? row.querySelector(".add-mins").value;
              row.querySelector(".add-hours").value = prevHours;
              row.querySelector(".add-mins").value = prevMins;
              recalcFrom(index);
              suppressEndTimeConfirm = false;
              return;
            }
            endTimeManual = true;
            endTimeEl.value = minutesToTime(proposedEnd);
            ensureBlocksForEndTime();
          }
          recalcFrom(index);
          if (index === lastIndex && !endTimeManual && !suppressEndTimeConfirm) {
            // no-op: main end time controlled by input
          }
          maybeRevealNext();
        });
      });

      row.querySelector(".start").addEventListener("input", () => recalcFrom(index));
      row.querySelector(".end").addEventListener("focus", () => {
        row.dataset.prevEnd = row.querySelector(".end").value;
      });
      row.querySelector(".end").addEventListener("input", async () => {
        const startMins = parseTimeToMinutes(row.querySelector(".start").value) ?? 0;
        let endMins = parseTimeToMinutes(row.querySelector(".end").value) ?? startMins;
        const mainEndMins = parseTimeToMinutes(endTimeEl.value);
        if (mainEndMins !== null && endMins > mainEndMins && !suppressEndTimeConfirm) {
          const ok = await openModal({
            title: "Extend End Time?",
            message: "This block exceeds the main End Time. Update End Time to fit?",
            confirmText: "Update",
            cancelText: "Keep",
            showCancel: true
          });
          if (!ok) {
            suppressEndTimeConfirm = true;
            const prevEnd = row.dataset.prevEnd ?? row.querySelector(".end").value;
            row.querySelector(".end").value = prevEnd;
            recalcFrom(index);
            suppressEndTimeConfirm = false;
            return;
          }
          endTimeManual = true;
          endTimeEl.value = minutesToTime(endMins);
          ensureBlocksForEndTime();
        }
        const duration = ((endMins - startMins) + 1440) % 1440;
        row.querySelector(".add-hours").value = Math.floor(duration / 60);
        row.querySelector(".add-mins").value = duration % 60;
        recalcFrom(index);
      });
      row.querySelector("textarea").addEventListener("input", () => {
        persistState();
        maybeRevealNext();
      });
      row.querySelector(".delete-row").addEventListener("click", () => {
        lastDeletedBlock = {
          index: parseInt(row.dataset.index, 10) || index,
          addHours: row.querySelector(".add-hours").value,
          addMins: row.querySelector(".add-mins").value,
          task: row.querySelector("textarea").value
        };
        row.remove();
        const rows = Array.from(rowsEl.querySelectorAll("tr"));
        if (currentBlockIndex >= rows.length) {
          currentBlockIndex = Math.max(0, rows.length - 1);
        }
        endTimeManual = false;
        recalcFrom(0);
        applyBlockVisibility();
        persistState();
      });
    }

    function getDurationMinutes() {
      const startMins = parseTimeToMinutes(startTimeEl.value);
      const endMins = parseTimeToMinutes(endTimeEl.value);
      if (startMins === null || endMins === null) return getRequiredMinutes();
      const duration = ((endMins - startMins) + 1440) % 1440;
      return duration === 0 ? getRequiredMinutes() : duration;
    }

    function generateRows() {
      rowsEl.innerHTML = "";
      const startMins = parseTimeToMinutes(startTimeEl.value) ?? 540;
      const defaultMinutes = parseInt(defaultMinutesEl.value, 10) || 60;
      const durationMinutes = getDurationMinutes();
      const blockCount = durationMinutes <= 0 ? 0 : Math.ceil(durationMinutes / defaultMinutes);
      let currentStart = startMins;

      for (let i = 0; i < blockCount; i++) {
        const row = buildRow(i, currentStart, defaultMinutes);
        rowsEl.appendChild(row);
        wireRow(row, i);
        currentStart += defaultMinutes;
      }
      currentBlockIndex = 0;
      endTimeManual = false;
      updateSummary();
      updateRemoveButtons();
      persistState();
      applyBlockVisibility();
    }

    function applyDefaultMinutesToAll() {
      const defaultMinutes = parseInt(defaultMinutesEl.value, 10) || 60;
      const addHours = Math.floor(defaultMinutes / 60);
      const addMins = defaultMinutes % 60;
      rowsEl.querySelectorAll(".add-hours").forEach((input) => {
        input.value = addHours;
      });
      rowsEl.querySelectorAll(".add-mins").forEach((input) => {
        input.value = addMins;
      });
      ensureBlocksForEndTime();
      const rows = Array.from(rowsEl.querySelectorAll("tr"));
      if (rows.length) {
        currentBlockIndex = rows.length - 1;
        applyBlockVisibility();
      }
      recalcFrom(0);
      if (!endTimeManual) {
        const lastEnd = rowsEl.querySelector("tr:last-child .end");
        if (lastEnd) endTimeEl.value = lastEnd.value;
      }
      updateRemoveButtons();
      persistState();
    }

    function openModal({ title, message, confirmText = "OK", cancelText = "Cancel", showCancel = true, html = false }) {
      return new Promise((resolve) => {
        if (modalActive) return resolve(false);
        modalActive = true;
        modalTitle.textContent = title || "Notice";
        if (html) {
          modalBody.innerHTML = message || "";
        } else {
          modalBody.textContent = message || "";
        }
        modalConfirm.textContent = confirmText;
        modalCancel.textContent = cancelText;
        modalCancel.style.display = showCancel ? "inline-flex" : "none";
        modalBackdrop.classList.add("active");
        modalBackdrop.setAttribute("aria-hidden", "false");

        const cleanup = () => {
          modalBackdrop.classList.remove("active");
          modalBackdrop.setAttribute("aria-hidden", "true");
          modalConfirm.onclick = null;
          modalCancel.onclick = null;
          modalActive = false;
        };

        modalConfirm.onclick = () => {
          cleanup();
          resolve(true);
        };
        modalCancel.onclick = () => {
          cleanup();
          resolve(false);
        };
      });
    }

    function buildSummaryText(payload) {
      const hours = Math.floor(payload.totalMinutes / 60);
      const mins = payload.totalMinutes % 60;
      const dayLabel = payload.dayType === "half" ? "Half Day" : "Full Day";
      const formatDate = (iso) => {
        if (!iso || !iso.includes("-")) return iso || "-";
        const [y, m, d] = iso.split("-");
        return `${d}-${m}-${y}`;
      };
      const dateSource = payload.workDateISO || payload.workDate;
      const header = `*${payload.employeeName || "-"}* Task Summary for ${formatDate(dateSource)}`;
      const meta = `Time : ${payload.startTime || "-"} - ${payload.endTime || "-"} (${hours}h ${mins}m)`;
      const blockLines = payload.blocks.map((b, idx) => {
        const startTime = `${b.start || "-"}`;
        const taskText = b.task || "-";
        return `${idx + 1}) ${startTime}\n   ${taskText}`;
      });
      const spacedBlocks = blockLines.flatMap((line, i) => (i === 0 ? [line] : ["", line]));
      return [header, meta, "", "*Tasks:*", ...spacedBlocks].join("\n");
    }

    function buildSheetsPayload(payload) {
      const tasksText = payload.blocks
        .map((b) => `Task ${b.block}: ${b.task || "-"}`)
        .join(" | ");
      return {
        Date: payload.workDate ? payload.workDate.split("-").reverse().join("-") : "",
        Name: payload.employeeName || "",
        Department: payload.department || "",
        "Tasks Count": payload.blocks.length,
        Day: payload.dayType === "half" ? "Half Day" : "Full Day",
        "Tasks (all in one cell)": tasksText
      };
    }

    function renderDeptPills() {
      deptPillsEl.innerHTML = "";
      departments.forEach((dept) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `pill${selectedDept === dept ? " active" : ""}`;
        btn.textContent = dept;
        btn.setAttribute("role", "radio");
        btn.setAttribute("aria-checked", selectedDept === dept ? "true" : "false");
        btn.addEventListener("click", () => {
          selectedDept = dept;
          if (!departmentMap[selectedDept].includes(selectedName)) {
            selectedName = "";
          }
          persistState();
          renderDeptPills();
          renderNamePills();
        });
        deptPillsEl.appendChild(btn);
      });
    }

    function renderNamePills() {
      namePillsEl.innerHTML = "";
      const names = departmentMap[selectedDept] || [];
      names.forEach((name) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `pill${selectedName === name ? " active" : ""}`;
        btn.textContent = name;
        btn.setAttribute("role", "radio");
        btn.setAttribute("aria-checked", selectedName === name ? "true" : "false");
        btn.addEventListener("click", () => {
          selectedName = name;
          persistState();
          renderNamePills();
        });
        namePillsEl.appendChild(btn);
      });
    }

    async function postViaFetch(payload) {
      const params = new URLSearchParams();
      Object.keys(payload).forEach((key) => {
        const val = payload[key];
        if (typeof val === "object") {
          params.append(key, JSON.stringify(val));
        } else {
          params.append(key, val == null ? "" : String(val));
        }
      });

      await fetch(WEBHOOK_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: params.toString(),
        keepalive: true,
      });
      return true;
    }

    function getDeptParam() {
      const deptParam = new URLSearchParams(window.location.search).get("dept");
      if (!deptParam) return "";
      const decoded = decodeURIComponent(deptParam).trim();
      const normalized = decoded.toLowerCase();
      if (normalized === "it") return "Information Technology";
      if (departments.includes(decoded)) return decoded;
      const match = departments.find((d) => d.toLowerCase() === normalized);
      return match || "";
    }

    function applyNameFromUrl() {
      const nameParam = new URLSearchParams(window.location.search).get("name");
      if (nameParam) {
        selectedName = decodeURIComponent(nameParam);
        const dept = departments.find((d) => (departmentMap[d] || []).includes(selectedName));
        if (dept) selectedDept = dept;
      }
    }

    function applyDeptFromUrl() {
      const decoded = getDeptParam();
      if (decoded) {
        selectedDept = decoded;
        if (!departmentMap[selectedDept].includes(selectedName)) {
          selectedName = "";
        }
        if (deptSectionEl) deptSectionEl.style.display = "none";
        if (nameSectionEl) nameSectionEl.style.display = "block";
      }
    }

    document.getElementById("workDate").addEventListener("change", () => {
      updateSummary();
      endTimeManual = false;
      persistState();
    });
    dayTypeEl.addEventListener("change", () => {
      updateSummary();
      endTimeManual = false;
      setAutoEndTime();
      ensureBlocksForEndTime();
      persistState();
    });
    startTimeEl.addEventListener("input", generateRows);
    defaultMinutesEl.addEventListener("input", () => {
      applyDefaultMinutesToAll();
      setAutoEndTime();
    });
    endTimeEl.addEventListener("input", () => {
      endTimeManual = true;
      ensureBlocksForEndTime();
      persistState();
    });
    addRowBtn.addEventListener("click", () => {
      if (restoreDeletedBlock()) return;
      const rows = Array.from(rowsEl.querySelectorAll("tr"));
      const lastEnd = rows.length
        ? parseTimeToMinutes(rows[rows.length - 1].querySelector(".end").value) ?? 0
        : (parseTimeToMinutes(startTimeEl.value) ?? 540);
      const mainEnd = parseTimeToMinutes(endTimeEl.value);
      if (mainEnd !== null && lastEnd < mainEnd) {
        addBlockRow(lastEnd);
        currentBlockIndex = rowsEl.querySelectorAll("tr").length - 1;
        recalcFrom(0);
        applyBlockVisibility();
        persistState();
        return;
      }
      openModal({
        title: "Extend End Time",
        message: "To add more tasks, update the End Time first.",
        confirmText: "OK",
        showCancel: false
      }).then(() => {
        endTimeEl.focus();
      });
    });
    undoDeleteBtn.addEventListener("click", () => {
      if (restoreDeletedBlock()) return;
      openModal({
        title: "Nothing to Undo",
        message: "No deleted block to restore.",
        confirmText: "OK",
        showCancel: false
      });
    });
    viewSummaryBtn.addEventListener("click", async () => {
      const payload = {
        employeeName: selectedName,
        workDate: document.getElementById("workDate").value,
        dayType: dayTypeEl.value,
        startTime: startTimeEl.value,
        endTime: endTimeEl.value,
        totalMinutes: totalScheduledMinutes(),
        blocks: Array.from(rowsEl.querySelectorAll("tr")).map((row, i) => ({
          block: i + 1,
          start: row.querySelector(".start").value,
          addHours: row.querySelector(".add-hours").value,
          addMinutes: row.querySelector(".add-mins").value,
          end: row.querySelector(".end").value,
          task: row.querySelector("textarea").value.trim(),
        })),
      };
      const msg = buildSummaryText(payload);
      const htmlMsg = msg
        .replace(/\*(.*?)\*/g, "<strong>$1</strong>")
        .replace(/\n/g, "<br>");
      await openModal({
        title: "Cliq Message Preview",
        message: htmlMsg,
        confirmText: "OK",
        showCancel: false,
        html: true
      });
    });
    resetBtn.addEventListener("click", () => {
      selectedName = "";
      document.getElementById("workDate").value = todayISO();
      startTimeEl.value = "09:00";
      defaultMinutesEl.value = 60;
      generateRows();
      renderNamePills();
      persistState();
    });

    submitBtn.addEventListener("click", async () => {
      statusEl.className = "status";
      statusEl.textContent = "";

      const workDate = document.getElementById("workDate").value;
      const total = totalScheduledMinutes();
      const requiredMinutes = getRequiredMinutes();

      const allTasksFilled = Array.from(rowsEl.querySelectorAll("textarea")).every(
        (t) => t.value.trim().length > 0
      );
      if (!allTasksFilled) {
        statusEl.classList.add("error");
        statusEl.textContent = "Please fill in tasks for every block before submitting.";
        await openModal({
          title: "Missing Tasks",
          message: statusEl.textContent,
          confirmText: "OK",
          showCancel: false
        });
        return;
      }

      if (dayTypeEl.value === "half") {
        if (total < requiredMinutes) {
          statusEl.classList.add("error");
          statusEl.textContent = `Half Day requires at least 5h. Current: ${Math.floor(total / 60)}h ${total % 60}m.`;
          await openModal({
            title: "Hours Required",
            message: statusEl.textContent,
            confirmText: "OK",
            showCancel: false
          });
          return;
        }
      } else if (total < requiredMinutes) {
        const targetLabel = "9h";
        statusEl.classList.add("error");
        statusEl.textContent = `Total must be at least ${targetLabel}. Current: ${Math.floor(total / 60)}h ${total % 60}m.`;
        await openModal({
          title: "Hours Required",
          message: statusEl.textContent,
          confirmText: "OK",
          showCancel: false
        });
        return;
      }

      const confirmMessage = `You are about to submit ${Math.floor(total / 60)}h ${total % 60}m for ${formatDateLong(workDate)} which can't be undone.`;
      const confirmed = await openModal({
        title: "Confirm Submit",
        message: confirmMessage,
        confirmText: "Submit",
        cancelText: "Cancel",
        showCancel: true
      });
      if (!confirmed) return;

      statusEl.textContent = "Submitting...";
      const workDateISO = document.getElementById("workDate").value;
      const workDateDisplay = workDateISO ? workDateISO.split("-").reverse().join("-") : "";
      const payload = {
        employeeName: selectedName,
        department: selectedDept,
        workDate: workDateDisplay,
        workDateISO,
        dayType: dayTypeEl.value,
        startTime: startTimeEl.value,
        endTime: endTimeEl.value,
        totalMinutes: totalScheduledMinutes(),
        blocks: Array.from(rowsEl.querySelectorAll("tr")).map((row, i) => ({
          block: i + 1,
          start: row.querySelector(".start").value,
          addHours: row.querySelector(".add-hours").value,
          addMinutes: row.querySelector(".add-mins").value,
          end: row.querySelector(".end").value,
          task: row.querySelector("textarea").value.trim(),
        })),
      };
      payload.summaryText = buildSummaryText(payload);
      payload.sheetsPayload = buildSheetsPayload(payload);

      try {
        const ok = await postViaFetch(payload);
        statusEl.classList.add(ok ? "success" : "error");
        statusEl.textContent = ok
          ? "Submitted successfully."
          : "Submit failed (browser blocked request).";
      } catch (err) {
        statusEl.classList.add("error");
        statusEl.textContent = "Submit failed (network error).";
      }
      persistState();
    });

    if (!restoreState()) {
      document.getElementById("workDate").value = todayISO();
      setAutoEndTime();
      generateRows();
      applyNameFromUrl();
      applyDeptFromUrl();
      if (!selectedDept) {
        selectedDept = departments[0] || "";
      }
      renderDeptPills();
      renderNamePills();
      persistState();
    } else {
      applyNameFromUrl();
      applyDeptFromUrl();
      renderDeptPills();
      renderNamePills();
      persistState();
    }
  </script>
</body>
</html>
